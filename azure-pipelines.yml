strategy:
  matrix:
    windows:
      imageName: 'windows-2019'
    mac:
      imageName: 'macOS-10.15'
    linux:
      imageName: 'ubuntu-18.04'

pool:
  vmImage: $(imageName)

variables:
  # Fixes checksum errors when downloading chrome
  homebrew_cask_opts: '--no-quarantine'
  CI: true

steps:
- script: |
    wget "https://golang.org/dl/go1.14.7.linux-amd64.tar.gz" --output-document "$(Agent.BuildDirectory)/go1.14.7.tar.gz"
    tar -C '$(Agent.BuildDirectory)' -xzf "$(Agent.BuildDirectory)/go1.14.7.tar.gz"
  condition: eq( variables['Agent.OS'], 'Linux' )
  displayName: 'Install Go 1.14.7 (Linux)'

- script: |
    brew install gnu-tar
  condition: eq( variables['Agent.OS'], 'Darwin' )
  displayName: 'Install gnu-tar (Darwin)'

- script: |
    echo $HOMEBREW_CASK_OPTS
    brew update
    brew cask install google-chrome
  condition: eq( variables['Agent.OS'], 'Darwin' )
  displayName: 'Install chrome (Darwin)'

- script: |
    wget "https://golang.org/dl/go1.14.7.darwin-amd64.tar.gz" --output-document "$(Agent.BuildDirectory)/go1.14.7.tar.gz"
    gtar -C '$(Agent.BuildDirectory)' -xzf "$(Agent.BuildDirectory)/go1.14.7.tar.gz"
  condition: eq( variables['Agent.OS'], 'Darwin' )
  displayName: 'Install Go 1.14.7 (Darwin)'

- powershell: |
    $ProgressPreference = 'SilentlyContinue'
    Invoke-WebRequest -Uri "https://golang.org/dl/go1.14.7.windows-amd64.zip" -OutFile "$(Agent.BuildDirectory)\go1.14.7.zip" -Verbose
    & ${env:ProgramFiles}\7-Zip\7z.exe x $(Agent.BuildDirectory)/go1.14.7.zip "-o$(Agent.BuildDirectory)" -y
  condition: eq( variables['Agent.OS'], 'Windows_NT' )
  displayName: 'Install Go 1.14.7 (Windows)'

# Linux
- bash: |
    echo "##vso[task.setvariable variable=GOROOT]$(Agent.BuildDirectory)/go"
    echo "##vso[task.setvariable variable=GOPATH]$(Agent.BuildDirectory)/gopath"
    echo "##vso[task.setvariable variable=GOBIN]$(Agent.BuildDirectory)/go/bin"
    echo "##vso[task.setvariable variable=modulePath]$(Agent.BuildDirectory)/go/src/github.com/$(build.repository.name)"
  condition: ne( variables['Agent.OS'], 'Windows_NT' )
  displayName: Properly configure our custom Go environment (Mac/Linux)

- bash: |
    echo "##vso[task.setvariable variable=GOROOT]$(Agent.BuildDirectory)\go"
    echo "##vso[task.setvariable variable=GOPATH]$(Agent.BuildDirectory)\gopath"
    echo "##vso[task.setvariable variable=GOBIN]$(Agent.BuildDirectory)\go\bin"
    echo "##vso[task.setvariable variable=modulePath]$(Agent.BuildDirectory)\go\src\github.com\$(build.repository.name)"
  condition: eq( variables['Agent.OS'], 'Windows_NT' )
  displayName: Properly configure our custom Go environment (Windows)

- task: DownloadSecureFile@1
  name: idrsa
  displayName: 'Securely download id_rsa from Azure vault'
  inputs:
    secureFile: 'id_rsa'

- task: DownloadSecureFile@1
  name: netrc
  displayName: 'Securely download netrc from Azure vault'
  inputs:
    secureFile: 'netrc'

- script: |
    echo '##vso[task.prependpath]$(GOROOT)/bin'
    echo '##vso[task.prependpath]$(GOPATH)/bin'
    mkdir -p ${GOPATH}\bin
    mkdir -p ${GOROOT}\bin
  condition: ne( variables['Agent.OS'], 'Windows_NT' )
  displayName: 'Set up the Go workspace (non-Windows)'

- script: |
    echo '##vso[task.prependpath]$(GOROOT)\bin'
    echo '##vso[task.prependpath]$(GOPATH)\bin'
    echo '##vso[task.setvariable variable=PATH;]$(GOROOT)\bin;$(GOPATH)\bin;$(PATH)'
    echo '$(GOROOT)'
    echo '$(GOPATH)'
    echo '$(PATH)'
    echo '%PATH%'
    mkdir ${GOPATH}\bin
    mkdir ${GOROOT}\bin
  condition: eq( variables['Agent.OS'], 'Windows_NT' )
  displayName: 'Set up the Go workspace (Windows)'

- script: |
    mv $(netrc.secureFilePath) ~/.netrc
    mkdir ~/.ssh
    sudo mv $(idrsa.secureFilePath) ~/.ssh/
    sudo chmod 400 ~/.ssh/id_rsa
  condition: ne( variables['Agent.OS'], 'Windows_NT' )
  displayName: 'Put secrets in their right places (non-Windows)'

- script: |
    echo '$(GOROOT)'
    echo '$(GOPATH)'
    echo '$(PATH)'
    echo '%PATH%'
    move $(netrc.secureFilePath) %USERPROFILE%\_netrc
    mkdir %USERPROFILE%\.ssh
    move $(idrsa.secureFilePath) %USERPROFILE%\.ssh\
  condition: eq( variables['Agent.OS'], 'Windows_NT' )
  displayName: 'Put secrets in their right places (Windows)'

- script: |
    curl -Ls https://github.com/github/hub/releases/download/v2.11.1/hub-linux-amd64-2.11.1.tgz | sudo tar -xvz -C /usr/bin --strip-components=2 hub-linux-amd64-2.11.1/bin/hub
    sudo chmod 755 /usr/bin/hub
  condition: eq( variables['Agent.OS'], 'Linux' )
  displayName: 'Install hub (Linux)'

- script: |
    curl -Ls https://github.com/github/hub/releases/download/v2.11.1/hub-darwin-amd64-2.11.1.tgz | sudo gtar -xvz -C /usr/local/bin --strip-components=2 hub-darwin-amd64-2.11.1/bin/hub
    sudo chmod 755 /usr/local/bin/hub
  condition: eq( variables['Agent.OS'], 'Darwin' )
  displayName: 'Install hub (Darwin)'

- script: |
    make deps
  displayName: 'make deps'

# make test will build the CLI as part of its work
# (for integration tests), so no need to run build
# make targets separately
- script: |
    make test
  displayName: 'make test'

- script: |
    make lint-licenses
  displayName: 'make lint-licenses'

- script: |
    bash <(curl -s https://codecov.io/bash)
  condition: eq( variables['Agent.OS'], 'Linux' )
  displayName: 'Generate Codecov report (only run on Linux)'

- script: |
    git checkout go.*
  displayName: 'Reset go.* just in case'


version: v1.0
name: Release to APT

agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1

execution_time_limit:
  hours: 1

blocks:
  - name: linux/amd64
    task:
      jobs:
        - name: linux/amd64
          commands:
            - checkout
            - export DEBEMAIL="Confluent Packaging <packages@confluent.io>"
            - git checkout -b debian-2.32.1
            - dch --newversion 2.32.1 "Release version 2.32.1" --urgency low
            - dch --release --distribution unstable ""
            - git commit -am "Tag Debian release."
            - git-buildpackage -us -uc --git-debian-branch=debian-$VERSION --git-upstream-tree=$BRANCH --git-verbose --git-builder="debuild --set-envvar=APPLY_PATCHES=$APPLY_PATCHES --set-envvar=PACKAGE_TYPE=deb --set-envvar=CLI_VERSION=$CLI_VERSION --set-envvar=VERSION=$VERSION --set-envvar=SKIP_TESTS=$SKIP_TESTS -i -I"
            - echo $SIGN
            - if [ "x$SIGN" == "xyes" ]; then sudo --login debsign $(readlink -f confluent-cli_*.changes); fi
            - cp confluent-cli_*.build confluent-cli_*.changes confluent-cli_*.tar.gz confluent-cli_*.dsc confluent-cli_*.deb /vagrant/output/
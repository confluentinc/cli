version: v1.0
name: Confluent CLI

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

execution_time_limit:
  hours: 2

# TODO: Give access to private repos

blocks:
  - name: Linux
    task:
      secrets:
        - name: vault_sem2_approle
      jobs:
        - name: Lint & Test
          commands:
            - sem-version go 1.17.6
            - git config --global url."git@github.com:".insteadOf "https://github.com/"
            - checkout
            
            - mkdir -p ${HOME}/bin/
            - export PATH=${PATH}:${HOME}/bin/
            
            # Install Vault
            - wget -O vault.zip https://vault-zipfile-public-cache.s3-us-west-2.amazonaws.com/vault_1.4.0_linux_amd64.zip
            - unzip vault.zip
            - mv vault ${HOME}/bin/vault
            - chmod +x ${HOME}/bin/vault

            # Log in to Vault
            - VAULT_TOKEN=$(vault write -field=token auth/app/devel/login role_id=${VAULT_ROLE_ID} secret_id=${VAULT_SECRET_ID})
            - vault login -no-print token="${VAULT_TOKEN}"
            
            # Execute script from Vault
            - vault kv get -field=script "v1/ci/kv/semaphore2/semaphore-secrets-global" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh

            - vault kv get -field=script "v1/ci/kv/semaphore2/ssh_id_rsa" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh
            - chmod 400 ~/.ssh/id_rsa
            - ssh-add ~/.ssh/id_rsa

            - vault kv get -field=script "v1/ci/kv/semaphore2/netrc" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh

            - vault kv get -field=script "v1/ci/kv/semaphore2/ssh_config" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh

            - vault kv get -field=script "v1/ci/kv/semaphore2/gitconfig" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh
              
            - vault kv get -field=script "v1/ci/kv/semaphore2/artifactory-docker-helm" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh

            - vault kv get -field=script "v1/ci/kv/semaphore2/testbreak-reporting" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh

            - vault kv get -field=script "v1/ci/kv/semaphore2/connect_aws_credentials" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh

            - vault kv get -field=script "v1/ci/kv/semaphore2/eng_aws" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh

            - vault kv get -field=script "v1/ci/kv/semaphore2/cpd_gcloud" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh

            - vault kv get -field=script "v1/ci/kv/semaphore2/halyard-secrets" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh

            - vault kv get -field=script "v1/ci/kv/service-foundations/cc-mk-include" > script.sh
            - cat script.sh
            - source script.sh
            - rm script.sh
            
            - export "GOPATH=$(go env GOPATH)"
            - echo $GOPATH
            - export "PATH=${GOPATH}/bin:${PATH}"
            
            - export GOPRIVATE=github.com/confluentinc
            - go get github.com/confluentinc/bincover
#            - make deps
#            - make build
#            - make lint
#            - make test

after_pipeline:
  task:
    jobs:
      - name: Publish Results
        commands:
          - test-results gen-pipeline-report

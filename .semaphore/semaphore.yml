version: v1.0
name: CLI Build and Release Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: "Build, Test, and Release"
    task:
      secrets:
        - name: semaphore-secrets-global
        - name: semaphore-secrets-cli
        - name: aws_credentials-caas_prod
        - name: ssh_id_rsa
        - name: netrc
        - name: ssh_config
        - name: gitconfig
      prologue:
        commands:
          - sem-version go 1.12
          - export "GOPATH=$(go env GOPATH)"
          - export "SEMAPHORE_GIT_DIR=${GOPATH}/src/github.com/confluentinc/${SEMAPHORE_PROJECT_NAME}"
          - export "PATH=${GOPATH}/bin:${PATH}"
          - mkdir -vp "${SEMAPHORE_GIT_DIR}" "${GOPATH}/bin"
          - git config --global url."git@github.com:".insteadOf "https://github.com/"
          - chmod 400 ~/.ssh/id_rsa
          - curl -Ls https://github.com/github/hub/releases/download/v2.11.1/hub-linux-amd64-2.11.1.tgz |
              sudo tar -xvz -C /usr/bin --strip-components=2 hub-linux-amd64-2.11.1/bin/hub &&
              sudo chmod 755 /usr/bin/hub
      jobs:
        - commands:
          - checkout
          - make deps
          - make test
          - make lint-licenses
          - bash <(curl -s https://codecov.io/bash)
          - make release-ci

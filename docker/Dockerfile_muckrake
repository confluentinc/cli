# Uses cc-cli Docker image to build CLI binaries

ARG GOOS=linux
ARG GOARCH=amd64

FROM 519856050701.dkr.ecr.us-east-1.amazonaws.com/docker/dev/confluentinc/cc-cli:latest

WORKDIR /workspace

COPY . .

ARG GOOS
ARG GOARCH

RUN set -ex && \
    go mod download && \
    go mod verify && \
    mkdir -p dist/confluent_${GOOS}_${GOARCH} && \
    COMMIT_SHA=$(git rev-parse --short HEAD 2>/dev/null || echo "dev") && \
    BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) && \
    echo "Building for ${GOOS}/${GOARCH} (commit: ${COMMIT_SHA}, date: ${BUILD_DATE})" && \
    CGO_ENABLED=1 GOOS=${GOOS} GOARCH=${GOARCH} go build \
    -ldflags="-s -w -X main.commit=${COMMIT_SHA} -X main.date=${BUILD_DATE}" \
    -o dist/confluent_${GOOS}_${GOARCH}/confluent \
    ./cmd/confluent && \
    ls -lh dist/confluent_${GOOS}_${GOARCH}/confluent

CMD ["/bin/sh"]

